{
  "ksql": "-- create_block_data_stream\n\nCREATE STREAM block_data (\n    \"block\" VARCHAR,\n    \"extrinsics\" ARRAY < VARCHAR >,\n    \"events\" ARRAY < VARCHAR >\n) WITH (\n    kafka_topic = 'block_data',\n    value_format = 'JSON'\n);\n\n-- create_block_stream\n\nCREATE STREAM BLOCK (\n    \"id\" BIGINT,\n    \"hash\" STRING,\n    \"state_root\" STRING,\n    \"extrinsics_root\" STRING,\n    \"parent_hash\" STRING,\n    \"author\" STRING,\n    \"session_id\" INT,\n    \"era\" INT,\n    \"last_log\" STRING,\n    \"digest\" STRING,\n    \"block_time\" BIGINT\n) WITH (\n    KAFKA_TOPIC='BLOCK',\n    PARTITIONS=1,\n    REPLICAS=1,\n    VALUE_FORMAT='AVRO'\n);\n\nINSERT INTO BLOCK SELECT\n                      CAST(EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.number') AS BIGINT) \"id\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.hash') \"hash\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.stateRoot') \"state_root\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.extrinsicsRoot') \"extrinsics_root\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.parentHash') \"parent_hash\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.author') \"author\",\n                      CAST(EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.session_id') AS INT) \"session_id\",\n                      CAST(EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.era') AS INT) \"era\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.last_log') \"last_log\",\n                      EXTRACTJSONFIELD(BLOCK_DATA.\"block\", '$.header.digest') \"digest\",\n                      CAST(EXTRACTJSONFIELD(BLOCK_DATA.\"extrinsics\"[1], '$.method.args.now') AS BIGINT) \"block_time\"\nFROM BLOCK_DATA BLOCK_DATA\nEMIT CHANGES;\n\n-- create_event_stream\n\nCREATE STREAM event (\n    \"block_id\" BIGINT,\n    \"event\" STRING\n) WITH (\n    kafka_topic = 'EVENT',\n    PARTITIONS = 1,\n    VALUE_FORMAT = 'AVRO',\n    REPLICAS = 1\n);\n\nINSERT INTO event\nSELECT\n    CAST(extractjsonfield(BLOCK_DATA.\"block\", '$.header.number') AS BIGINT) AS \"block_id\",\n    EXPLODE(BLOCK_DATA.\"events\") AS \"event\"\n\nFROM BLOCK_DATA BLOCK_DATA EMIT CHANGES;\n\n-- create_event_extraction\n\nCREATE STREAM EVENT_EXTRACTION (\n    \"id\" STRING,\n    \"block_id\" BIGINT,\n    \"section\" STRING,\n    \"method\" STRING,\n    \"data\" STRING,\n    \"event\" STRING\n) WITH (\n    KAFKA_TOPIC='EVENT_EXTRACTION',\n    PARTITIONS=1,\n    REPLICAS=1,\n    VALUE_FORMAT='AVRO'\n);\n\nINSERT INTO EVENT_EXTRACTION SELECT\n    extractjsonfield(E.\"event\", '$.id') \"id\",\n    E.\"block_id\" \"block_id\",\n    extractjsonfield(E.\"event\", '$.section') \"section\",\n    extractjsonfield(E.\"event\", '$.method') \"method\",\n    extractjsonfield(E.\"event\", '$.data') \"data\",\n    extractjsonfield(E.\"event\", '$.event') \"event\"\nFROM EVENT E\nEMIT CHANGES;\n\n-- create_extrinsic_stream\nCREATE STREAM extrinsic (\n    \"block_id\" BIGINT,\n    \"extrinsic\" STRING\n) WITH (\n    kafka_topic = 'EXTRINSIC',\n    PARTITIONS = 1,\n    VALUE_FORMAT = 'AVRO',\n    REPLICAS = 1\n);\n\nINSERT INTO extrinsic\nSELECT\n    CAST(extractjsonfield(BLOCK_DATA.\"block\", '$.header.number') AS BIGINT) AS \"block_id\",\n    EXPLODE(BLOCK_DATA.\"extrinsics\") AS \"extrinsic\"\n\nFROM BLOCK_DATA BLOCK_DATA EMIT CHANGES;\n\n-- create_extrinsic_extraction\n\nCREATE STREAM EXTRINSIC_EXTRACTION (\n    \"id\" STRING,\n    \"block_id\" BIGINT,\n    \"section\" STRING,\n    \"method\" STRING,\n    \"ref_event_ids\" STRING,\n    \"extrinsic\" STRING\n) WITH (\n    KAFKA_TOPIC='EXTRINSIC_EXTRACTION',\n    PARTITIONS=1,\n    REPLICAS=1,\n    VALUE_FORMAT='AVRO'\n);\n\nINSERT INTO EXTRINSIC_EXTRACTION SELECT\n    extractjsonfield(E.\"extrinsic\", '$.id') \"id\",\n    E.\"block_id\" \"block_id\",\n    extractjsonfield(E.\"extrinsic\", '$.section') \"section\",\n    extractjsonfield(E.\"extrinsic\", '$.method') \"method\",\n    extractjsonfield(E.\"extrinsic\", '$.ref_event_ids') \"ref_event_ids\",\n    extractjsonfield(E.\"extrinsic\", '$.extrinsic')  \"extrinsic\"\nFROM EXTRINSIC E\nEMIT CHANGES;\n\n-- create_profit_events_filter_rules\n-- {\"ksql\":\"CREATE TABLE profit_events_filter_rules (method VARCHAR) WITH (kafka_topic='profit_events_filter_rules', value_format='JSON', KEY='method');\"}\nCREATE TABLE profit_events_filter_rules (method VARCHAR(30)) WITH (\n                                                                 KAFKA_TOPIC = 'profit_events_filter_rules',\n                                                                 VALUE_FORMAT = 'JSON',\n                                                                 KEY = 'method',\n                                                                 PARTITIONS = 1,\n                                                                 REPLICAS = 1\n                                                                 );\nINSERT INTO profit_events_filter_rules (method) VALUES ('Reward');\nINSERT INTO profit_events_filter_rules (method) VALUES ('Deposit');\n\n-- create_profit_events_filter_rules_stream\n\nCREATE STREAM profit_events_filter (\n    \"block_id\" BIGINT,\n    \"event\" STRING\n) WITH (\n    kafka_topic = 'PROFIT_EVENTS_FILTER',\n    PARTITIONS = 1,\n    VALUE_FORMAT = 'AVRO',\n    REPLICAS = 1\n);\n\nINSERT INTO profit_events_filter\nSELECT\n    E.\"block_id\" \"block_id\",\n    E.\"event\" \"event\"\nFROM EVENT E\n         INNER JOIN PROFIT_EVENTS_FILTER_RULES P ON extractjsonfield(E.\"event\", '$.method') = P.method\nWHERE extractjsonfield(E.\"event\", '$.section') != 'treasury'\nEMIT CHANGES;\n\n",
  "streamsProperties": {}
}